{{ define "host" }}
    {{ $addrLen := len .Container.Addresses }}
    {{ $address := .Container }}
    {{ if gt $addrLen 0 }}
        {{ $address := index .Container.Addresses 0 }}
    {{ end }}
    {{ if $address }}
address=/{{.Host }}/{{ $address.IP }}
    {{ end }}
{{ end }}

{{ $tld := or ($.Env.DOMAIN_TLD) "docker" }}
{{ range $index, $container := $ }}
    {{ $hosts := coalesce $container.Name (print "*." $container.Name) }}
    {{ $host_part := split $container.Name "_" }}
    {{ $host_part_len := len $host_part }}
    {{ if eq $host_part_len 3 }}
        {{ template "host" (dict "Container" $container "Host" (print (index $host_part 0) "." $tld)) }}
        {{ template "host" (dict "Container" $container "Host" (print (index $host_part 1) "." (index $host_part 0) "." $tld)) }}
        {{ template "host" (dict "Container" $container "Host" (print (index $host_part 2) "." (index $host_part 1) "." (index $host_part 0) "." $tld)) }}
    {{ end }}
    {{ template "host" (dict "Container" $container "Host" (print $container.Name "." $tld)) }}
{{ end }}

{{ range $host, $containers := groupByMulti $ "Env.DOMAIN_NAME" "," }}
    {{ range $index, $container := $containers }}
        {{ template "host" (dict "Container" $container "Host" (print $host)) }}
    {{ end }}
{{ end }}
